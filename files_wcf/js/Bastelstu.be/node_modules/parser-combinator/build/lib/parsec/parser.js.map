{"version":3,"sources":["../../../src/lib/parsec/parser.js"],"names":["Parser","parse","f","bind","self","input","index","map","p","filter","v","a","flatmap","result","append","b","array","length","then","drop","thenRight","returns","choice","some","or","none","repeatable","l","occurrence","buffered","ofParser","hint","details","console","log","bindAccepted","accept_a","value","offset","fold","accept","accept_b","consumed","reject","location","reject_b","reject_a","occurrences","current","isAccepted"],"mappings":"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","file":"parser.js","sourcesContent":["/*\r\n * Parsec\r\n * https://github.com/d-plaindoux/parsec\r\n *\r\n * Copyright (c) 2016 Didier Plaindoux\r\n * Licensed under the LGPL2 license.\r\n */\r\n\r\n/*\r\n * Parsec: Direct Style Monadic Parser Combinators For The Real World\r\n *\r\n * http://research.microsoft.com/en-us/um/people/daan/download/papers/parsec-paper.pdf\r\n */\r\n\r\nimport stream from '../stream/index';\r\n\r\nimport option from '../data/option';\r\nimport list from '../data/list';\r\n\r\nimport response from './response';\r\n\r\n/**\r\n * Parser class\r\n */\r\nexport default class Parser {\r\n    // (Stream 'c -> number -> Response 'a 'c) -> Parser 'a 'c\r\n    constructor(parse) {\r\n        this.parse = parse;\r\n    }\r\n\r\n    // Parser 'a 'c => ('a -> Parser 'b 'c) -> Parser 'b 'c\r\n    flatmap(f) {\r\n        return bind(this, f);\r\n    }\r\n\r\n    // Parser 'a 'c => ('a -> 'b) -> Parser 'b 'c\r\n    map(f) {\r\n        var self = this;\r\n\r\n        return new Parser((input, index = 0) =>\r\n            self.parse(input, index).map(f)\r\n        );\r\n    }\r\n\r\n    // Parser 'a 'c => ('a -> boolean) -> Parser 'a 'c\r\n    filter(p) {\r\n        var self = this;\r\n\r\n        return new Parser((input, index = 0) =>\r\n            self.parse(input, index).filter(p)\r\n        );\r\n    }\r\n\r\n    // Parser 'a 'c => Comparable 'a -> Parser 'a 'c\r\n    match(v) {\r\n        return this.filter(a => a === v);\r\n    }\r\n\r\n    // Parser 'a 'c => Parser 'b 'c -> Parser ('a,'b) 'c\r\n    then(p) {\r\n        return this.flatmap(a =>\r\n            p.map(b => {\r\n                let result = list(a).append(list(b)).array();\r\n                if (result.length == 1) {\r\n                    return result[0];\r\n                } else {\r\n                    return result;\r\n                }\r\n            })\r\n        );\r\n    }\r\n\r\n    concat(p) {\r\n        return this.then(p);\r\n    }\r\n\r\n    drop() {\r\n        return this.map(item => []);\r\n    }\r\n\r\n    // Parser 'a 'c => Parser 'b 'c -> Parser 'a 'c\r\n    thenLeft(p) {\r\n        return this.then(p.drop());\r\n    }\r\n\r\n    // Parser 'a 'c => Parser 'b 'c -> Parser 'b 'c\r\n    thenRight(p) {\r\n        return this.drop().then(p);\r\n    }\r\n\r\n    // Parser 'a 'c => 'b -> Parser 'b 'c\r\n    thenReturns(v) {\r\n        return this.thenRight(returns(v));\r\n    }\r\n\r\n    // Parser 'a 'c -> Parser 'a 'c\r\n    or(p) {\r\n        return choice(this, p);\r\n    }\r\n\r\n    // Parser 'a 'c => unit -> Parser (Option 'a) 'c\r\n    opt() {\r\n        return this.map(option.some).or(returns(option.none()));\r\n    }\r\n\r\n    // Parser 'a 'c => unit -> Parser (List 'a) 'c\r\n    rep() {\r\n        return repeatable(this, () => true, l => l !== 0);\r\n    }\r\n\r\n    // Parser 'a 'c => number -> Parser (List 'a) 'c\r\n    occurrence(occurrence) {\r\n        return repeatable(this, l => l < occurrence, l => l === occurrence);\r\n    }\r\n\r\n    // Parser 'a 'c => unit -> Parser (List 'a) 'c\r\n    optrep() {\r\n        return repeatable(this, () => true, () => true);\r\n    }\r\n\r\n    // Parser 'a 'c => Parser 'b 'a -> Parser 'b 'c\r\n    chain(p) {\r\n        var self = this;\r\n\r\n        return new Parser((input, index = 0) =>\r\n            p.parse(stream.buffered(stream.ofParser(self, input)), index)\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Prints a hint if the parser enters in this step\r\n     * @param hint\r\n     * @returns the equivalent Parser\r\n     */\r\n    debug(hint, details = true) {\r\n        var f = p => {\r\n            if (details) {\r\n                console.log('[debug] : ', hint, p);\r\n            } else {\r\n                console.log('[debug] : ', hint);\r\n            }\r\n\r\n            return p;\r\n        };\r\n        return this.map(f);\r\n    }\r\n}\r\n\r\n// Response 'a 'c -> ('a -> Parser 'b 'c) -> Response 'b 'c\r\nfunction bindAccepted(accept_a, f) {\r\n    return f(accept_a.value)\r\n        .parse(accept_a.input, accept_a.offset)\r\n        .fold(\r\n            accept_b =>\r\n                response.accept(\r\n                    accept_b.value,\r\n                    accept_b.input,\r\n                    accept_b.offset,\r\n                    accept_a.consumed || accept_b.consumed\r\n                ),\r\n            reject_b =>\r\n                response.reject(\r\n                    accept_a.input.location(reject_b.offset),\r\n                    accept_a.consumed || reject_b.consumed\r\n                )\r\n        );\r\n}\r\n\r\n// Parser 'a 'c -> ('a -> Parser 'b 'c) -> Parser 'b 'c\r\nfunction bind(self, f) {\r\n    return new Parser((input, index = 0) =>\r\n        self\r\n            .parse(input, index)\r\n            .fold(accept_a => bindAccepted(accept_a, f), reject_a => reject_a)\r\n    );\r\n}\r\n\r\n// Parser 'a 'c -> Parser 'a 'c -> Parser 'a 'c\r\nfunction choice(self, f) {\r\n    return new Parser((input, index = 0) =>\r\n        self\r\n            .parse(input, index)\r\n            .fold(\r\n                accept => accept,\r\n                reject => (reject.consumed ? reject : f.parse(input, index))\r\n            )\r\n    );\r\n}\r\n\r\n// Parser 'a 'c -> unit -> Parser (List 'a) 'c\r\nfunction repeatable(self, occurrences, accept) {\r\n    return new Parser((input, index = 0) => {\r\n        var consumed = false,\r\n            value = list(),\r\n            offset = index,\r\n            current = self.parse(input, index),\r\n            occurrence = 0;\r\n\r\n        while (current.isAccepted() && occurrences(occurrence)) {\r\n            occurrence += 1;\r\n            value = value.append(list(current.value));\r\n            consumed = consumed || current.consumed;\r\n            offset = current.offset;\r\n            current = self.parse(input, current.offset);\r\n        }\r\n\r\n        if (accept(occurrence)) {\r\n            return response.accept(value, input, offset, consumed);\r\n        }\r\n\r\n        return response.reject(offset, consumed);\r\n    });\r\n}\r\n\r\n/*\r\n * Builders\r\n */\r\n\r\nfunction returns(v) {\r\n    return new Parser((input, index = 0) =>\r\n        response.accept(v, input, index, false)\r\n    );\r\n}\r\n"]}